<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Styles -->
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- OpenLayers library -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v8.1.0/ol.css"
    />

    <style>
      #card-body {
        width: 175px;
        background-color: white;
        border-radius: 10px;
        border: 1px solid black;
        padding: 0 10px 10px;
        box-shadow: 2px 2px 4px #000000;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .flx {
        display: flex;
        gap: 5px;
        justify-content: center;
        align-items: center;
        margin: 0;
      }
      .flx span {
        font-size: 9px;
        font-weight: 700;
        font-family: "Montserrat", sans-serif;
        padding: 5px 0;
      }
      .imago {
        width: 150px;
        height: 150px;
        background-size: cover;
        box-sizing: border-box;
        border-radius: 10px;
        margin: 0 auto;
      }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Styles for the application -->
    <link rel="stylesheet" href="./styles/prompt.css" type="text/css" />
    <link rel="stylesheet" href="./styles/viewer.css" type="text/css" />

    <!-- Application icon -->
    <link rel="icon" href="./images/favicon.png" type="image/png" />

    <title>OAU | CampusNav</title>
  </head>

  <body onload="init()">
    <nav class="navbar navbar-expand-lg bg-light navbar-light fixed-top">
      <div class="container-fluid">
        <div>
          <a class="navbar-brand" href="index.html"
            ><strong>OAU</strong> | Quarters Nav</a
          >
        </div>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapsibleNavbar"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="" id="collapsibleNavbar">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showPanel('pnl-basemap')"
                >Base layer</a
              >
            </li>
            <form id="searchForm" onsubmit="handleSearch(event)">
              <div class="search-up" id="searchUp">
                <input
                  type="text"
                  id="search"
                  list="destinations"
                  name="search"
                  onkeyup="handleKeyUp(event)"
                  placeholder="Find destination on campus......."
                />
                <button type="submit" class="search-button">
                  <img height="20" src="./images/search.png" />
                </button>
              </div>
              <datalist id="destinations"></datalist>
            </form>
            <li class="nav-item">
              <a class="nav-link" href="viewer.html">Clear results</a>
            </li>
          </ul>
        </div>

        <div class="justify-content-end" id="collapsibleNavbar">
          <div class="form-inline my-2 my-lg-0" id="auth-div">
            <a class="sign_button" href="signup.html">Sign up</a>
            <a class="log_button" href="login.html">Login</a>
            <!-- </div> -->
          </div>
          <div class="form-inline my-2 my-lg-0">
            <!-- Profile Avatar -->
            <div class="avatar" id="avatar"></div>
          </div>
        </div>
      </div>
    </nav>

    <div id="pnl-basemap" class="card panel panel-tool">
      <div class="card-header">
        Base layer
        <span class="pull-right clickable close-icon" data-effect="fadeOut"
          ><i class="fa fa-times"></i
        ></span>
      </div>
      <div class="card-body">
        <form>
          <div class="form-group">
            <div class="form-check">
              <input
                id="base-osm"
                type="radio"
                name="basemap"
                class="form-check-input"
                value="osm"
                checked
              /><label for="base-osm">OpenStreetMap</label>
            </div>
            <div class="form-check">
              <input
                id="base-esri-natgeo"
                type="radio"
                name="basemap"
                class="form-check-input"
                value="arcgis"
              /><label for="base-esri-natgeo">3D view</label>
            </div>
            <div class="form-check">
              <input
                id="base-otm"
                type="radio"
                name="basemap"
                class="form-check-input"
                value="otm"
              /><label for="base-otm">OpenTopoMap</label>
            </div>
            <div class="form-check">
              <input
                id="base-esri-wtm"
                type="radio"
                name="basemap"
                class="form-check-input"
                value="esri_wtm"
              /><label for="base-esri-wtm">ESRI World Topo Map</label>
            </div>
            <div class="form-check">
              <input
                id="base-esri-natgeo"
                type="radio"
                name="basemap"
                class="form-check-input"
                value="esri_natgeo"
              /><label for="base-esri-natgeo">Stadia Outdoor</label>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div id="pnl-contact" class="card panel panel-info">
      <div class="card-header">
        <strong>Contact</strong>
        <span class="pull-right clickable close-icon" data-effect="fadeOut"
          ><i class="fa fa-times"></i
        ></span>
      </div>
      <div class="card-body">
        <p class="card-text">
          For information about the <strong>Faculty EDM</strong> visit
          <a href="https://eportal.oauife.edu.ng/home.php"
            >eportal.oauife.edu.ng</a
          >. <br /><br />
          You can contact us via e-mail:
        </p>
        <ul>
          <li>
            <strong>Oyetunde Adeola :</strong>
            <a href="mailto:oyetundeaa@gmail.com">oyetundeaa@gmail.com</a>
          </li>
          <li>
            <strong>Oyetunde Adeola:</strong>
            <a href="mailto:aaoyetunde@student.oauife.edu.ng"
              >aaoyetunde@student.oauife.edu.ng</a
            >
          </li>
        </ul>
      </div>
    </div>

    <section class="search-result flex flex-col md:flex-row h-screen">
      <!-- Map container -->
      <div class="search-basemap flex-1 relative" id="map">
        <div id="popup"></div>
      </div>

      <!-- Information panel -->
      <div
        class="search-panel shadow bg-white w-full md:w-96 p-6 overflow-y-auto"
      >
        <!-- Header -->
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <h3 class="text-lg font-semibold text-gray-800">Building Details</h3>
          <button>
            <img height="15px" src="./images/close.png" alt="close" />
          </button>
        </div>

        <!-- Description -->
        <p class="text-sm text-gray-600 mb-4">
          Information about the selected building inside the quarters.
        </p>

        <!-- Building Info -->
        <div class="space-y-3">
          <div>
            <span class="block text-xs text-gray-500">Occupant:</span>
            <span class="text-base font-medium text-gray-800" id="occupant"
              >Dr Keita</span
            >
          </div>
          <div>
            <span class="block text-xs text-gray-500">House ID: </span>
            <span class="text-base font-medium text-gray-800" id="hid"
              >RD14 L19</span
            >
          </div>
          <div>
            <span class="block text-xs text-gray-500"
              >Faculty/Department:
            </span>
            <span class="text-base font-medium text-gray-800" id="department"
              >RECTAS</span
            >
          </div>
          <div>
            <span class="block text-xs text-gray-500">GID</span>
            <span class="text-base font-medium text-gray-800" id="gid">37</span>
          </div>
        </div>

        <!-- Action -->
        <div class="mt-6">
          <button
            class="sign inline-flex items-center bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow"
            id="getRouteBtn"
            href="signup.html"
          >
            Show me the way
            <img
              class="ml-2"
              height="12px"
              src="./images/arrow.png"
              alt="arrow"
            />
          </button>
        </div>
      </div>
    </section>

    <footer class="fixed-bottom bg-light">
      <div class="container-fluid d-flex justify-content-center">
        <a href="#">About</a>
        <a href="#" onclick="showPanel('pnl-contact')">Contact</a>
      </div>
    </footer>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Openlayers -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.1.0/dist/ol.js"></script>
    <!--Script for api call-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Own script -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="./scripts/viewer.js"></script>
    <script>
      console.log({ idToken });
      if (!idToken) {
        window.location.href = `${baseUrl}/signup.html`;
      }

      serverUrl = "http://localhost:5000";

      let myBuildingData = null;
      // const LAT = 7.5162813;
      // const LON = 4.553;

      const ORS_API_KEY =
        "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjczZTcwMDRhYmQ2ODQ3MmI5Zjg1Mjk5NzJlNWJjOWUwIiwiaCI6Im11cm11cjY0In0=";

      const searchTerm = window.location?.toString()?.split("?")?.slice(-1);
      const term = searchTerm[0].split("(")[1].replace(")", "");
      document.getElementById("search").value = searchTerm
        .toString()
        .replace(/[^a-zA-Z0-9. ]/g, " ")
        .replace(/[0-46-9]/g, "");

      // const getSearchDetails = (term) => {
      if (term) {
        init();
        axios
          .get(`${serverUrl}/spatial/get-building/${term}`)
          .then((res) => {
            const data = res.data.data;

            const building = data[0];
            myBuildingData = data[0];

            document.getElementById("occupant").innerHTML = building.name_of_oc;
            document.getElementById("hid").innerHTML = building.hid;
            document.getElementById("gid").innerHTML = building.gid;
            document.getElementById("department").innerHTML =
              building.fac_dept_u;

            // Clear old destinations
            const destinations = document.getElementById("destinations");
            destinations.innerHTML = building.name_of_oc + "'s place";

            if (data.length === 0) {
              destinations.innerHTML = `<option value="Not Found"></option>`;
              return;
            }

            // Loop through each building
            data.forEach((building) => {
              console.log({ building });

              // Parse building geometry (assuming GeoJSON format in "geometry" field)
              let geom = building.geometry;
              if (typeof geom === "string") {
                geom = JSON.parse(geom); // convertf to JSON if string
              }

              // Create feature from geometry
              const feature = new ol.format.GeoJSON().readFeature(geom, {
                dataProjection: "EPSG:4326",
                featureProjection: "EPSG:3857",
              });

              // Style in yellow
              feature.setStyle(
                new ol.style.Style({
                  stroke: new ol.style.Stroke({
                    color: "yellow",
                    width: 2,
                  }),
                  fill: new ol.style.Fill({
                    color: "rgba(255, 255, 0, 0.4)", // semi-transparent yellow
                  }),
                })
              );

              // Add vector layer
              const vectorSource = new ol.source.Vector({
                features: [feature],
              });

              const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
              });

              mainMap.addLayer(vectorLayer);

              // Zoom to building extent
              mainMap.getView().fit(vectorSource.getExtent(), {
                padding: [50, 50, 50, 50],
                duration: 1000,
              });

              // Add to destinations dropdown
              destinations.innerHTML += `<option value="${building.name_of_oc} (${building.gid})"></option>`;
            });
          })
          .catch((err) => {
            console.error(err.message);
          });
      }

      const routeLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
      });

      async function getRoute(startLon, startLat, endLon, endLat) {
        try {
          // Send request to backend API
          const response = await axios.get(
            `${serverUrl}/spatial/get-building-route`,
            {
              params: {
                // startLon: startLon,
                // startLat: startLat,
                // endLon: endLon,
                // endLat: endLat,
                startLon: 4.5347581317,
                startLat: 7.52638642,
                endLon: 4.53475813175,
                endLat: 7.526386424,
              },
            }
          );

          const geojson = response.data;

          // Convert GeoJSON to OpenLayers feature
          const routeFeature = new ol.format.GeoJSON().readFeature(geojson, {
            dataProjection: "EPSG:4326",
            featureProjection: "EPSG:3857",
          });

          // Style for the route
          routeFeature.setStyle(
            new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: "#ffd000",
                width: 4,
              }),
            })
          );

          // Clear old route and add new one
          routeLayer.getSource().clear();
          routeLayer.getSource().addFeature(routeFeature);

          // Zoom to route extent
          map.getView().fit(routeLayer.getSource().getExtent(), {
            padding: [50, 50, 50, 50],
          });
        } catch (err) {
          console.error("Error fetching route:", err);
        }
      }

      mainMap.addLayer(routeLayer);

      // --- Vector layer for route ---
      const routeSource = new ol.source.Vector();
      const n_routeLayer = new ol.layer.Vector({
        source: routeSource,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: "yellow",
            width: 4,
          }),
        }),
      });
      mainMap.addLayer(n_routeLayer);

      // --- Get current location ---
      function getCurrentLocation() {
        return new Promise((resolve, reject) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const coords = [pos.coords.longitude, pos.coords.latitude];

                resolve(coords);
              },
              (err) => reject(err)
            );
          } else {
            reject("Geolocation not supported");
          }
        });
      }

      // --- Fetch route from ORS ---
      async function getRoute(start, end) {
        try {
          const url =
            "https://api.openrouteservice.org/v2/directions/driving-car";
          const res = await axios.get(url, {
            params: {
              api_key: ORS_API_KEY,
              start: `${start[0]},${start[1]}`,
              end: `${end[0]},${end[1]}`,
            },
          });

          const route = res.data.features[0].geometry;

          // Convert GeoJSON LineString to OpenLayers feature
          const routeFeature = new ol.format.GeoJSON().readFeature(route, {
            dataProjection: "EPSG:4326",
            featureProjection: "EPSG:3857",
          });

          routeSource.clear();
          routeSource.addFeature(routeFeature);

          // Zoom to route extent
          mainMap.getView().fit(routeSource.getExtent(), {
            padding: [50, 50, 50, 50],
            duration: 1000,
          });
        } catch (err) {
          console.error("Routing error:", err);
          alert("Error fetching route. Check console for details.");
        }
      }

      // --- Button click ---
      document
        .getElementById("getRouteBtn")
        .addEventListener("click", async () => {
          try {
            const currentLocation = await getCurrentLocation(); // [lon, lat]
            // const currentLocation = [LON, LAT]; // [lon, lat]
            // const destination = [4.553, 7.519]; // Example destination (building centroid)

            console.log({
              myBuildingData: JSON.parse(myBuildingData.geometry),
            });

            const geomFeature = {
              type: "Feature",
              geometry: JSON.parse(myBuildingData.geometry),
              properties: {},
            };

            const centroid = turf.centroid(geomFeature);
            const destination = centroid.geometry.coordinates;

            console.log({ currentLocation });

            console.log("From:", currentLocation, "To:", destination);

            getRoute(currentLocation, destination);
          } catch (err) {
            alert("Unable to get location: " + err.message);
          }
        });
    </script>
    <script src="./scripts/helper.js"></script>
  </body>
</html>
